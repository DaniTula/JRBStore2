{% extends "base.html" %}

{% block title %}JRBStore2 - Cat치logo{% endblock %}

{% block content %}

{# ===================== NAVBAR PRINCIPAL ===================== #}
<nav class="navbar navbar-expand-md navbar-dark bg-primary shadow-sm">
  <div class="container-fluid px-3 px-md-4">

    <!-- Bot칩n panel administrativo -->
    {# Bot칩n panel administrativo: solo staff / superuser #}
    
    {% if user.is_staff or user.is_superuser %}
      <button class="btn btn-outline-light me-2"
              type="button"
              data-bs-toggle="offcanvas"
              data-bs-target="#adminPanel"
              aria-controls="adminPanel">
        <span class="navbar-toggler-icon"></span>
      </button>
    {% endif %}


    <!-- Logo / nombre -->
    <a class="navbar-brand fw-bold" href="{% url 'home' %}">
      JRBStore
    </a>

    <!-- Hamburguesa -->
    <button class="navbar-toggler" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNavbar"
            aria-controls="mainNavbar"
            aria-expanded="false"
            aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNavbar">
      <!-- Buscador centrado -->
      <form class="d-flex flex-grow-1 justify-content-center my-2 my-md-0"
            method="get"
            action="{% url 'home' %}">
        <div class="input-group input-group-sm" style="max-width: 520px;">
          <input class="form-control"
                 type="search"
                 name="q"
                 value="{{ filters.q }}"
                 placeholder="Buscar juegos por nombre o descripci칩n"
                 aria-label="Buscar" />
          <button class="btn btn-light" type="submit">
            Buscar
          </button>
        </div>

        {# Preservar filtros al buscar #}
        {% if filters.plataforma %}
          <input type="hidden" name="plataforma" value="{{ filters.plataforma }}">
        {% endif %}
        {% if filters.tipo %}
          <input type="hidden" name="tipo" value="{{ filters.tipo }}">
        {% endif %}
        {% for g_id in filters.generos %}
          <input type="hidden" name="generos" value="{{ g_id }}">
        {% endfor %}
        {% if filters.precio_min %}
          <input type="hidden" name="precio_min" value="{{ filters.precio_min }}">
        {% endif %}
        {% if filters.precio_max %}
          <input type="hidden" name="precio_max" value="{{ filters.precio_max }}">
        {% endif %}
      </form>

      <!-- Carrito + login -->
      <ul class="navbar-nav ms-md-3 align-items-center">
        <li class="nav-item me-2">
          <a href="{% url 'cart_detail' %}"
             class="btn btn-outline-light btn-sm position-relative d-flex align-items-center justify-content-center"
             style="width: 42px; height: 32px;">
            <!-- 칈cono del carrito -->
            <span aria-hidden="true">游</span>
            <!-- Texto solo para lectores de pantalla -->
            <span class="visually-hidden">Carrito</span>

            {% if cart_total_items %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ cart_total_items }}
              </span>
            {% endif %}
          </a>
        </li>

        <!-- Enlaces de autenticaci칩n -->
        <li class="nav-item ms-2">
          <div class="d-flex align-items-center text-white small">
            {% if user.is_authenticated %}
              <span class="me-3">
                Hola, <strong>{{ user.first_name|default:user.username }}</strong>
              </span>

              <a href="{% url 'account_dashboard' %}"
                 class="text-white text-decoration-none me-3">
                Mi cuenta
              </a>

              <form action="{% url 'logout' %}" method="post" class="d-inline mb-0">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-light">
                  Cerrar sesi칩n
                </button>
              </form>
            {% else %}
              <a href="{% url 'login' %}" class="text-white text-decoration-none me-2">
                Iniciar sesi칩n
              </a>
              <span class="mx-1">/</span>
              <a href="{% url 'register' %}" class="text-white text-decoration-none ms-2">
                Registrarse
              </a>
            {% endif %}
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>

{# ===================== CONTENIDO PRINCIPAL ===================== #}
<div class="bg-light py-3">
  <div class="container-fluid px-3 px-md-4">
    <div class="row g-3 g-lg-4">

      {# ---------- SIDEBAR FILTROS ---------- #}
      <aside class="col-12 col-lg-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white border-0 pb-0">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0 fw-semibold">Filtrar resultados</h6>
                <small class="text-muted">Acota la b칰squeda seg칰n tus preferencias</small>
              </div>
              <a href="{% url 'home' %}"
                 class="small text-decoration-none text-primary">
                Limpiar
              </a>
            </div>
          </div>

          <div class="card-body pt-3">
            <form method="get" action="{% url 'home' %}">
              <div class="accordion accordion-flush" id="filtersAccordion">

                {# Consola #}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingPlataforma">
                    <button class="accordion-button collapsed py-2"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapsePlataforma"
                            aria-expanded="true"
                            aria-controls="collapsePlataforma">
                      Consola
                    </button>
                  </h2>
                  <div id="collapsePlataforma"
                       class="accordion-collapse collapse show"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body px-0 pt-2">
                      <select class="form-select form-select-sm" name="plataforma">
                        <option value="">Todas</option>
                        {% for code, label in plataformas %}
                          <option value="{{ code }}"
                                  {% if filters.plataforma == code %}selected{% endif %}>
                            {{ label }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                {# Tipo / Formato #}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingTipo">
                    <button class="accordion-button collapsed py-2"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseTipo"
                            aria-expanded="false"
                            aria-controls="collapseTipo">
                      Tipo de producto
                    </button>
                  </h2>
                  <div id="collapseTipo"
                       class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body px-0 pt-2">
                      <div class="form-check mb-1">
                        <input class="form-check-input"
                               type="radio"
                               name="tipo"
                               id="tipoTodos"
                               value=""
                               {% if not filters.tipo %}checked{% endif %}>
                        <label class="form-check-label" for="tipoTodos">
                          Todos
                        </label>
                      </div>

                      {% for code, label in formatos %}
                        <div class="form-check mb-1">
                          <input class="form-check-input"
                                 type="radio"
                                 name="tipo"
                                 id="tipo{{ code }}"
                                 value="{{ code }}"
                                 {% if filters.tipo == code %}checked{% endif %}>
                          <label class="form-check-label" for="tipo{{ code }}">
                            {{ label }}
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>

                {# G칠neros #}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingGeneros">
                    <button class="accordion-button collapsed py-2"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseGeneros"
                            aria-expanded="false"
                            aria-controls="collapseGeneros">
                      G칠neros
                    </button>
                  </h2>
                  <div id="collapseGeneros"
                       class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body px-0 pt-2"
                         style="max-height: 260px; overflow-y: auto;">
                      {% for genero in generos_disponibles %}
                        <div class="form-check mb-1">
                          <input class="form-check-input"
                                 type="checkbox"
                                 name="generos"
                                 value="{{ genero.id }}"
                                 id="gen{{ genero.id }}"
                                 {% if genero.id in filters.generos %}checked{% endif %}>
                          <label class="form-check-label" for="gen{{ genero.id }}">
                            {{ genero.nombre }}
                          </label>
                        </div>
                      {% endfor %}
                      <small class="d-block mt-1 text-muted">
                        Puedes seleccionar uno o varios.
                      </small>
                    </div>
                  </div>
                </div>

                {# Precio #}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingPrecio">
                    <button class="accordion-button collapsed py-2"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapsePrecio"
                            aria-expanded="false"
                            aria-controls="collapsePrecio">
                      Rango de precio
                    </button>
                  </h2>
                  <div id="collapsePrecio"
                       class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body px-0 pt-2">
                      <div class="row g-2 mb-1">
                        <div class="col-6">
                          <input type="number"
                                 class="form-control form-control-sm"
                                 name="precio_min"
                                 min="0"
                                 placeholder="M칤n"
                                 value="{{ filters.precio_min }}">
                        </div>
                        <div class="col-6">
                          <input type="number"
                                 class="form-control form-control-sm"
                                 name="precio_max"
                                 min="0"
                                 placeholder="M치x"
                                 value="{{ filters.precio_max }}">
                        </div>
                      </div>
                      <small class="text-muted">
                        Valores en CLP.
                      </small>
                    </div>
                  </div>
                </div>

              </div> {# /accordion #}

              <div class="mt-3">
                <button class="btn btn-primary w-100 btn-sm mb-2" type="submit">
                  Aplicar filtros
                </button>
                <a href="{% url 'home' %}"
                   class="btn btn-outline-secondary w-100 btn-sm">
                  Quitar filtros
                </a>
              </div>
            </form>
          </div>
        </div>
      </aside>

      {# ---------- CAT츼LOGO PRODUCTOS ---------- #}
      <main class="col-12 col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="mb-0 fw-semibold">Cat치logo de juegos</h5>
            <small class="text-muted">
              {{ productos|length }} resultado{{ productos|length|pluralize }}
              {% if filters.q %}
                para "<span class="fw-semibold">{{ filters.q }}</span>"
              {% endif %}
            </small>
          </div>

          {% if filters.plataforma or filters.tipo or filters.generos or filters.precio_min or filters.precio_max %}
            <div class="text-end small">
              <span class="text-muted me-1">Filtros activos:</span>
              {% if filters.plataforma %}
                <span class="badge bg-light text-dark border me-1">
                  {{ filtros_humanos.plataforma }}
                </span>
              {% endif %}
              {% if filters.tipo %}
                <span class="badge bg-light text-dark border me-1">
                  {{ filtros_humanos.tipo }}
                </span>
              {% endif %}
              {% for g in filtros_humanos.generos %}
                <span class="badge bg-light text-dark border me-1">
                  {{ g }}
                </span>
              {% endfor %}
              {% if filters.precio_min or filters.precio_max %}
                <span class="badge bg-light text-dark border">
                  {{ filtros_humanos.precio }}
                </span>
              {% endif %}
            </div>
          {% endif %}
        </div>

        {% if productos %}
          <div class="row g-3">
            {% for producto in productos %}
              <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                <div class="card h-100 border-0 shadow-sm rounded-3">

                  {% if producto.imagen %}
                    <img src="{{ producto.imagen.url }}"
                         class="card-img-top"
                         alt="{{ producto.nombre }}"
                         style="height: 190px; object-fit: cover;">
                  {% endif %}

                  <div class="card-body d-flex flex-column">

                    <h6 class="card-title mb-1 text-truncate"
                        title="{{ producto.nombre }}">
                      {{ producto.nombre }}
                    </h6>

                    <p class="mb-1 small text-muted">
                      {{ producto.anio_lanzamiento|date:"Y" }} 췅 {{ producto.plataforma }}
                    </p>

                    <p class="mb-1 small">
                      <span class="badge bg-secondary me-1">
                        {{ producto.get_formato_display }}
                      </span>
                      <span class="badge bg-success">
                        {{ producto.get_estado_display }}
                      </span>
                    </p>

                    <p class="mb-1 small text-muted">
                      {{ producto.generos.all|join:", " }}
                    </p>

                    <p class="card-text small mb-2">
                      {{ producto.descripcion|default:"Sin descripci칩n."|truncatechars:90 }}
                    </p>

                    <div class="mt-auto d-flex justify-content-between align-items-end">
                      <div class="d-flex flex-column">
                        <span class="small text-muted">Precio</span>
                        <span class="fw-bold fs-6">
                          ${{ producto.valor }}
                        </span>
                      </div>

                      <form method="post" action="{% url 'cart_add' producto.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary btn-sm">
                          Agregar
                        </button>
                      </form>
                    </div>
                  </div>

                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="card border-0 shadow-sm w-100">
            <div class="card-body text-center py-5">
              <h5 class="card-title mb-2">
                No se encontraron productos
              </h5>
              <p class="text-muted mb-0">
                Ajusta los filtros o limpia la b칰squeda para ver todo el cat치logo.
              </p>
            </div>
          </div>
        {% endif %}
      </main>

    </div>
  </div>
</div>

{# ===================== PANEL ADMINISTRATIVO ===================== #}

{% if user.is_staff or user.is_superuser %}
  <div class="offcanvas offcanvas-start"
       tabindex="-1"
       id="adminPanel"
       aria-labelledby="adminPanelLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="adminPanelLabel">
        Panel administrativo
      </h5>
      <button type="button"
              class="btn-close text-reset"
              data-bs-dismiss="offcanvas"
              aria-label="Cerrar"></button>
    </div>

    <div class="offcanvas-body">
      <div class="list-group">
        <a href="/admin/" class="list-group-item list-group-item-action">
          Admin Django
        </a>
        <a href="{% url 'product_list' %}" class="list-group-item list-group-item-action">
          Productos
        </a>
      </div>
    </div>
  </div>
{% endif %}

{% endblock %}



